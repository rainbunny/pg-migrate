"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.implementExecutor = void 0;

var _executeQuery = require("./execute-query");

var _buildQuery = require("./build-query");

/* eslint-disable no-param-reassign */
const implementExecutor = (executor, log) => {
  /** Execute query */
  executor.executeQuery = async query => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)(query);
    return (0, _executeQuery.executeQuery)(executor, queryText, params, log).then(res => res.rows);
  };
  /** Count records in the query */


  executor.count = async query => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)({ ...query,
      fields: [],
      pageIndex: undefined,
      rowsPerPage: undefined,
      sortBy: undefined,
      limit: undefined,
      offset: undefined
    });
    const countQueryText = `SELECT COUNT(*) FROM (${queryText}) AS T`;
    return (0, _executeQuery.executeQuery)(executor, countQueryText, params, log).then(res => res.rows[0].count);
  };
  /** Get record by id */


  executor.getById = table => async (id, fields, idField = 'id') => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)({
      table,
      whereClause: `${idField} = :id`,
      fields,
      params: {
        id
      }
    });
    return (0, _executeQuery.executeQuery)(executor, queryText, params).then(res => res.rows.length > 0 ? res.rows[0] : undefined);
  };
  /** create new record */


  executor.create = table => async record => {
    const paramNames = Object.keys(record);
    const params = paramNames.map(name => record[name]);
    const fieldsText = paramNames.join(',');
    const paramsText = Array.from(Array(paramNames.length), (_x, i) => `$${i + 1}`).join(',');
    const queryText = `INSERT INTO ${table}(${fieldsText}) VALUES(${paramsText}) RETURNING id`;
    return (0, _executeQuery.executeQuery)(executor, queryText, params, log).then(res => res.rows[0].id);
  };
  /** update existing record */


  executor.update = table => async (id, updatedData, idField = 'id') => {
    const paramNames = Object.keys(updatedData);
    const params = paramNames.map(name => updatedData[name]);
    const paramsText = paramNames.map((paramName, index) => `${paramName}=$${index + 2}`).join(',');
    const queryText = `UPDATE ${table} SET ${paramsText} WHERE ${idField} = $1`;
    await (0, _executeQuery.executeQuery)(executor, queryText, [id, ...params], log);
  };
  /** delete existing record */


  executor.remove = table => async (id, idField = 'id') => {
    const queryText = `DELETE FROM ${table} WHERE ${idField} = $1`;
    await (0, _executeQuery.executeQuery)(executor, queryText, [id], log);
  };

  return executor;
};

exports.implementExecutor = implementExecutor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbXBsZW1lbnQtZXhlY3V0b3IudHMiXSwibmFtZXMiOlsiaW1wbGVtZW50RXhlY3V0b3IiLCJleGVjdXRvciIsImxvZyIsImV4ZWN1dGVRdWVyeSIsInF1ZXJ5IiwicXVlcnlUZXh0IiwicGFyYW1zIiwidGhlbiIsInJlcyIsInJvd3MiLCJjb3VudCIsImZpZWxkcyIsInBhZ2VJbmRleCIsInVuZGVmaW5lZCIsInJvd3NQZXJQYWdlIiwic29ydEJ5IiwibGltaXQiLCJvZmZzZXQiLCJjb3VudFF1ZXJ5VGV4dCIsImdldEJ5SWQiLCJ0YWJsZSIsImlkIiwiaWRGaWVsZCIsIndoZXJlQ2xhdXNlIiwibGVuZ3RoIiwiY3JlYXRlIiwicmVjb3JkIiwicGFyYW1OYW1lcyIsIk9iamVjdCIsImtleXMiLCJtYXAiLCJuYW1lIiwiZmllbGRzVGV4dCIsImpvaW4iLCJwYXJhbXNUZXh0IiwiQXJyYXkiLCJmcm9tIiwiX3giLCJpIiwidXBkYXRlIiwidXBkYXRlZERhdGEiLCJwYXJhbU5hbWUiLCJpbmRleCIsInJlbW92ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBOztBQUNBOztBQUpBO0FBTU8sTUFBTUEsaUJBQWlCLEdBQUcsQ0FDL0JDLFFBRCtCLEVBRS9CQyxHQUYrQixLQUdwQjtBQUNYO0FBQ0FELEVBQUFBLFFBQVEsQ0FBQ0UsWUFBVCxHQUF3QixNQUFVQyxLQUFWLElBQTJDO0FBQ2pFLFVBQU07QUFBQ0MsTUFBQUEsU0FBRDtBQUFZQyxNQUFBQTtBQUFaLFFBQXNCLDRCQUFXRixLQUFYLENBQTVCO0FBQ0EsV0FBTyxnQ0FBZ0JILFFBQWhCLEVBQTBCSSxTQUExQixFQUFxQ0MsTUFBckMsRUFBNkNKLEdBQTdDLEVBQWtESyxJQUFsRCxDQUF3REMsR0FBRCxJQUFTQSxHQUFHLENBQUNDLElBQXBFLENBQVA7QUFDRCxHQUhEO0FBS0E7OztBQUNBUixFQUFBQSxRQUFRLENBQUNTLEtBQVQsR0FBaUIsTUFBT04sS0FBUCxJQUEyQztBQUMxRCxVQUFN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LFdBQVcsQ0FBQ1QsSUFBRCxDQUFwQyxDQUFmO0FBQ0EsVUFBTUcsVUFBVSxHQUFHUCxVQUFVLENBQUNHLEdBQVgsQ0FBZSxDQUFDVyxTQUFELEVBQVlDLEtBQVosS0FBdUIsR0FBRUQsU0FBVSxLQUFJQyxLQUFLLEdBQUcsQ0FBRSxFQUFoRSxFQUFtRVQsSUFBbkUsQ0FBd0UsR0FBeEUsQ0FBbkI7QUFDQSxVQUFNNUIsU0FBUyxHQUFJLFVBQVNlLEtBQU0sUUFBT2MsVUFBVyxVQUFTWixPQUFRLE9BQXJFO0FBQ0EsVUFBTSxnQ0FBdUJyQixRQUF2QixFQUFpQ0ksU0FBakMsRUFBNEMsQ0FBQ2dCLEVBQUQsRUFBSyxHQUFHZixNQUFSLENBQTVDLEVBQTZESixHQUE3RCxDQUFOO0FBQ0QsR0FSSDtBQVVBOzs7QUFDQUQsRUFBQUEsUUFBUSxDQUFDMEMsTUFBVCxHQUNHdkIsS0FBRCxJQUNBLE9BQVdDLEVBQVgsRUFBbUJDLE9BQU8sR0FBRyxJQUE3QixLQUFxRDtBQUNuRCxVQUFNakIsU0FBUyxHQUFJLGVBQWNlLEtBQU0sVUFBU0UsT0FBUSxPQUF4RDtBQUNBLFVBQU0sZ0NBQWFyQixRQUFiLEVBQXVCSSxTQUF2QixFQUFrQyxDQUFDZ0IsRUFBRCxDQUFsQyxFQUF3Q25CLEdBQXhDLENBQU47QUFDRCxHQUxIOztBQU9BLFNBQU9ELFFBQVA7QUFDRCxDQW5FTSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXBhcmFtLXJlYXNzaWduICovXG5pbXBvcnQgdHlwZSB7RGJRdWVyeSwgRXhlY3V0b3IsIEV4dGVuZGVkUG9vbCwgRXh0ZW5kZWRQb29sQ2xpZW50LCBMb2dnZXJ9IGZyb20gJ0BsaWIvaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7ZXhlY3V0ZVF1ZXJ5fSBmcm9tICcuL2V4ZWN1dGUtcXVlcnknO1xuaW1wb3J0IHtidWlsZFF1ZXJ5fSBmcm9tICcuL2J1aWxkLXF1ZXJ5JztcblxuZXhwb3J0IGNvbnN0IGltcGxlbWVudEV4ZWN1dG9yID0gPFNvdXJjZSBleHRlbmRzIEV4dGVuZGVkUG9vbCB8IEV4dGVuZGVkUG9vbENsaWVudD4oXG4gIGV4ZWN1dG9yOiBTb3VyY2UgJiBFeGVjdXRvcixcbiAgbG9nPzogTG9nZ2VyLFxuKTogU291cmNlID0+IHtcbiAgLyoqIEV4ZWN1dGUgcXVlcnkgKi9cbiAgZXhlY3V0b3IuZXhlY3V0ZVF1ZXJ5ID0gYXN5bmMgPFQ+KHF1ZXJ5OiBEYlF1ZXJ5KTogUHJvbWlzZTxUW10+ID0+IHtcbiAgICBjb25zdCB7cXVlcnlUZXh0LCBwYXJhbXN9ID0gYnVpbGRRdWVyeShxdWVyeSk7XG4gICAgcmV0dXJuIGV4ZWN1dGVRdWVyeTxUPihleGVjdXRvciwgcXVlcnlUZXh0LCBwYXJhbXMsIGxvZykudGhlbigocmVzKSA9PiByZXMucm93cyk7XG4gIH07XG5cbiAgLyoqIENvdW50IHJlY29yZHMgaW4gdGhlIHF1ZXJ5ICovXG4gIGV4ZWN1dG9yLmNvdW50ID0gYXN5bmMgKHF1ZXJ5OiBEYlF1ZXJ5KTogUHJvbWlzZTxudW1iZXI+ID0+IHtcbiAgICBjb25zdCB7cXVlcnlUZXh0LCBwYXJhbXN9ID0gYnVpbGRRdWVyeSh7XG4gICAgICAuLi5xdWVyeSxcbiAgICAgIGZpZWxkczogW10sXG4gICAgICBwYWdlSW5kZXg6IHVuZGVmaW5lZCxcbiAgICAgIHJvd3NQZXJQYWdlOiB1bmRlZmluZWQsXG4gICAgICBzb3J0Qnk6IHVuZGVmaW5lZCxcbiAgICAgIGxpbWl0OiB1bmRlZmluZWQsXG4gICAgICBvZmZzZXQ6IHVuZGVmaW5lZCxcbiAgICB9KTtcbiAgICBjb25zdCBjb3VudFF1ZXJ5VGV4dCA9IGBTRUxFQ1QgQ09VTlQoKikgRlJPTSAoJHtxdWVyeVRleHR9KSBBUyBUYDtcbiAgICByZXR1cm4gZXhlY3V0ZVF1ZXJ5PHtjb3VudDogbnVtYmVyfT4oZXhlY3V0b3IsIGNvdW50UXVlcnlUZXh0LCBwYXJhbXMsIGxvZykudGhlbigocmVzKSA9PiByZXMucm93c1swXS5jb3VudCk7XG4gIH07XG5cbiAgLyoqIEdldCByZWNvcmQgYnkgaWQgKi9cbiAgZXhlY3V0b3IuZ2V0QnlJZCA9XG4gICAgKHRhYmxlOiBzdHJpbmcpID0+XG4gICAgYXN5bmMgPFJlY29yZCwgSWQ+KGlkOiBJZCwgZmllbGRzPzogc3RyaW5nW10sIGlkRmllbGQgPSAnaWQnKTogUHJvbWlzZTxSZWNvcmQgfCB1bmRlZmluZWQ+ID0+IHtcbiAgICAgIGNvbnN0IHtxdWVyeVRleHQsIHBhcmFtc30gPSBidWlsZFF1ZXJ5KHt0YWJsZSwgd2hlcmVDbGF1c2U6IGAke2lkRmllbGR9ID0gOmlkYCwgZmllbGRzLCBwYXJhbXM6IHtpZH19KTtcbiAgICAgIHJldHVybiBleGVjdXRlUXVlcnk8UmVjb3JkPihleGVjdXRvciwgcXVlcnlUZXh0LCBwYXJhbXMpLnRoZW4oKHJlcykgPT5cbiAgICAgICAgcmVzLnJvd3MubGVuZ3RoID4gMCA/IHJlcy5yb3dzWzBdIDogdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICB9O1xuXG4gIC8qKiBjcmVhdGUgbmV3IHJlY29yZCAqL1xuICBleGVjdXRvci5jcmVhdGUgPVxuICAgICh0YWJsZTogc3RyaW5nKSA9PlxuICAgIGFzeW5jIDxSZWNvcmQsIElkPihyZWNvcmQ6IFBhcnRpYWw8UmVjb3JkPik6IFByb21pc2U8SWQ+ID0+IHtcbiAgICAgIGNvbnN0IHBhcmFtTmFtZXMgPSBPYmplY3Qua2V5cyhyZWNvcmQpIGFzIChrZXlvZiBSZWNvcmQpW107XG4gICAgICBjb25zdCBwYXJhbXMgPSBwYXJhbU5hbWVzLm1hcCgobmFtZSkgPT4gcmVjb3JkW25hbWVdKTtcbiAgICAgIGNvbnN0IGZpZWxkc1RleHQgPSBwYXJhbU5hbWVzLmpvaW4oJywnKTtcbiAgICAgIGNvbnN0IHBhcmFtc1RleHQgPSBBcnJheS5mcm9tKEFycmF5KHBhcmFtTmFtZXMubGVuZ3RoKSwgKF94LCBpKSA9PiBgJCR7aSArIDF9YCkuam9pbignLCcpO1xuICAgICAgY29uc3QgcXVlcnlUZXh0ID0gYElOU0VSVCBJTlRPICR7dGFibGV9KCR7ZmllbGRzVGV4dH0pIFZBTFVFUygke3BhcmFtc1RleHR9KSBSRVRVUk5JTkcgaWRgO1xuICAgICAgcmV0dXJuIGV4ZWN1dGVRdWVyeTx7aWQ6IG5ldmVyfT4oZXhlY3V0b3IsIHF1ZXJ5VGV4dCwgcGFyYW1zLCBsb2cpLnRoZW4oKHJlcykgPT4gcmVzLnJvd3NbMF0uaWQpO1xuICAgIH07XG5cbiAgLyoqIHVwZGF0ZSBleGlzdGluZyByZWNvcmQgKi9cbiAgZXhlY3V0b3IudXBkYXRlID1cbiAgICAodGFibGU6IHN0cmluZykgPT5cbiAgICBhc3luYyA8UmVjb3JkLCBJZD4oaWQ6IElkLCB1cGRhdGVkRGF0YTogUGFydGlhbDxSZWNvcmQ+LCBpZEZpZWxkID0gJ2lkJyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgY29uc3QgcGFyYW1OYW1lcyA9IE9iamVjdC5rZXlzKHVwZGF0ZWREYXRhKSBhcyAoa2V5b2YgUmVjb3JkKVtdO1xuICAgICAgY29uc3QgcGFyYW1zID0gcGFyYW1OYW1lcy5tYXAoKG5hbWUpID0+IHVwZGF0ZWREYXRhW25hbWVdKTtcbiAgICAgIGNvbnN0IHBhcmFtc1RleHQgPSBwYXJhbU5hbWVzLm1hcCgocGFyYW1OYW1lLCBpbmRleCkgPT4gYCR7cGFyYW1OYW1lfT0kJHtpbmRleCArIDJ9YCkuam9pbignLCcpO1xuICAgICAgY29uc3QgcXVlcnlUZXh0ID0gYFVQREFURSAke3RhYmxlfSBTRVQgJHtwYXJhbXNUZXh0fSBXSEVSRSAke2lkRmllbGR9ID0gJDFgO1xuICAgICAgYXdhaXQgZXhlY3V0ZVF1ZXJ5PHtpZDogSWR9PihleGVjdXRvciwgcXVlcnlUZXh0LCBbaWQsIC4uLnBhcmFtc10sIGxvZyk7XG4gICAgfTtcblxuICAvKiogZGVsZXRlIGV4aXN0aW5nIHJlY29yZCAqL1xuICBleGVjdXRvci5yZW1vdmUgPVxuICAgICh0YWJsZTogc3RyaW5nKSA9PlxuICAgIGFzeW5jIDxJZD4oaWQ6IElkLCBpZEZpZWxkID0gJ2lkJyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgY29uc3QgcXVlcnlUZXh0ID0gYERFTEVURSBGUk9NICR7dGFibGV9IFdIRVJFICR7aWRGaWVsZH0gPSAkMWA7XG4gICAgICBhd2FpdCBleGVjdXRlUXVlcnkoZXhlY3V0b3IsIHF1ZXJ5VGV4dCwgW2lkXSwgbG9nKTtcbiAgICB9O1xuXG4gIHJldHVybiBleGVjdXRvcjtcbn07XG4iXX0=
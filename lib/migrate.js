"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.migrate = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _pg = require("pg");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-console */
const createMigrationTableQuery = `
  CREATE TABLE IF NOT EXISTS migration(
      id INT PRIMARY KEY,
      version VARCHAR(4000) NOT NULL,
      createdAt BIGINT NOT NULL DEFAULT(
          extract(
              epoch
              from now()
          ) * 1000
      ) 
  );
`;
const getLatestVersionQuery = `
  SELECT id, version
  FROM migration
  ORDER BY id DESC
  LIMIT 1;
`;
const insertVersionQuery = `
  INSERT INTO migration(id, version) VALUES($1, $2);
`;
const deleteVersionQuery = `
  DELETE FROM migration WHERE version = $1;
`;

const performMigration = ({
  currentVersion,
  mode,
  targetVersion,
  client,
  migrationFolder
}) => {
  const versionFilePaths = _fs.default.readdirSync(`${migrationFolder}/${mode}`);

  if (targetVersion && !versionFilePaths.includes(`${targetVersion}.sql`)) {
    return Promise.reject(new Error(`Invalid target version: ${targetVersion}`));
  }

  let currentId = currentVersion ? currentVersion.id : -1;
  const currentVer = currentVersion === null || currentVersion === void 0 ? void 0 : currentVersion.version;
  const currentVersionIndex = versionFilePaths.indexOf(`${currentVer}.sql`);
  const targetVersionIndex = versionFilePaths.indexOf(`${targetVersion}.sql`);
  let executor = Promise.resolve();

  if (mode === 'up') {
    versionFilePaths.filter((_versionFilePath, index) => index > currentVersionIndex && (!targetVersion || index <= targetVersionIndex)).forEach(versionFilePath => {
      executor = executor.then(() => console.log(`Migrating up ${versionFilePath}...`)).then(() => client.query(_fs.default.readFileSync(`${migrationFolder}/${mode}/${versionFilePath}`, 'utf8'))).then(() => {
        currentId += 1;
        return client.query(insertVersionQuery, [currentId, versionFilePath.split('.')[0]]);
      }).then(() => {// do nothing
      });
    });
    return executor;
  }

  if (!targetVersion) {
    return Promise.reject(new Error(`Target version is required!`));
  }

  versionFilePaths.filter((_versionFilePath, index) => (!targetVersion || index > targetVersionIndex) && index <= currentVersionIndex).reverse().forEach(versionFilePath => {
    executor = executor.then(() => console.log(`Migrating down ${versionFilePath}...`)).then(() => client.query(_fs.default.readFileSync(`${migrationFolder}/${mode}/${versionFilePath}`, 'utf8'))).then(() => client.query(deleteVersionQuery, [versionFilePath.split('.')[0]])).then(() => {// do nothing
    });
  });
  return executor;
};

const migrate = ({
  mode,
  targetVersion,
  migrationFolder,
  poolConfig
}) => new _pg.Pool(poolConfig).connect().then(client => Promise.resolve().then(() => client.query('BEGIN')).then(() => client.query(createMigrationTableQuery)).then(() => client.query(getLatestVersionQuery)).then(result => result.rows.length === 0 ? undefined : result.rows[0]).then(currentVersion => performMigration({
  mode,
  targetVersion,
  currentVersion,
  client,
  migrationFolder
})).then(() => client.query('COMMIT')).catch(err => client.query('ROLLBACK').then(() => Promise.reject(err))).finally(() => client.release()).then(() => {// do nothing
}));

exports.migrate = migrate;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9taWdyYXRlLnRzIl0sIm5hbWVzIjpbImNyZWF0ZU1pZ3JhdGlvblRhYmxlUXVlcnkiLCJnZXRMYXRlc3RWZXJzaW9uUXVlcnkiLCJpbnNlcnRWZXJzaW9uUXVlcnkiLCJkZWxldGVWZXJzaW9uUXVlcnkiLCJwZXJmb3JtTWlncmF0aW9uIiwiY3VycmVudFZlcnNpb24iLCJtb2RlIiwidGFyZ2V0VmVyc2lvbiIsImNsaWVudCIsIm1pZ3JhdGlvbkZvbGRlciIsInZlcnNpb25GaWxlUGF0aHMiLCJmcyIsInJlYWRkaXJTeW5jIiwiaW5jbHVkZXMiLCJQcm9taXNlIiwicmVqZWN0IiwiRXJyb3IiLCJjdXJyZW50SWQiLCJpZCIsImN1cnJlbnRWZXIiLCJ2ZXJzaW9uIiwiY3VycmVudFZlcnNpb25JbmRleCIsImluZGV4T2YiLCJ0YXJnZXRWZXJzaW9uSW5kZXgiLCJleGVjdXRvciIsInJlc29sdmUiLCJmaWx0ZXIiLCJfdmVyc2lvbkZpbGVQYXRoIiwiaW5kZXgiLCJmb3JFYWNoIiwidmVyc2lvbkZpbGVQYXRoIiwidGhlbiIsImNvbnNvbGUiLCJsb2ciLCJxdWVyeSIsInJlYWRGaWxlU3luYyIsInNwbGl0IiwicmV2ZXJzZSIsIm1pZ3JhdGUiLCJwb29sQ29uZmlnIiwiUG9vbCIsImNvbm5lY3QiLCJyZXN1bHQiLCJyb3dzIiwibGVuZ3RoIiwidW5kZWZpbmVkIiwiY2F0Y2giLCJlcnIiLCJmaW5hbGx5IiwicmVsZWFzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOzs7O0FBRkE7QUFJQSxNQUFNQSx5QkFBeUIsR0FBSTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBWEE7QUFhQSxNQUFNQyxxQkFBcUIsR0FBSTtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBTEE7QUFPQSxNQUFNQyxrQkFBa0IsR0FBSTtBQUM1QjtBQUNBLENBRkE7QUFJQSxNQUFNQyxrQkFBa0IsR0FB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QTtBQUxlLENBQUQsQ0FScEIsRUFnQkdzQixJQWhCSCxDQWdCUSxNQUFNdkIsTUFBTSxDQUFDMEIsS0FBUCxDQUFhLFFBQWIsQ0FoQmQsRUFpQkdZLEtBakJILENBaUJVQyxHQUFELElBQVN2QyxNQUFNLENBQUMwQixLQUFQLENBQWEsVUFBYixFQUF5QkgsSUFBekIsQ0FBOEIsTUFBTWpCLE9BQU8sQ0FBQ0MsTUFBUixDQUFlZ0MsR0FBZixDQUFwQyxDQWpCbEIsRUFrQkdDLE9BbEJILENBa0JXLE1BQU14QyxNQUFNLENBQUN5QyxPQUFQLEVBbEJqQixFQW1CR2xCLElBbkJILENBbUJRLE1BQU0sQ0FDVjtBQUNELENBckJILENBREYsQ0FESyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQge1Bvb2wsIFBvb2xDbGllbnQsIFBvb2xDb25maWcsIFF1ZXJ5UmVzdWx0fSBmcm9tICdwZyc7XG5cbmNvbnN0IGNyZWF0ZU1pZ3JhdGlvblRhYmxlUXVlcnkgPSBgXG4gIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIG1pZ3JhdGlvbihcbiAgICAgIGlkIElOVCBQUklNQVJZIEtFWSxcbiAgICAgIHZlcnNpb24gVkFSQ0hBUig0MDAwKSBOT1QgTlVMTCxcbiAgICAgIGNyZWF0ZWRBdCBCSUdJTlQgTk9UIE5VTEwgREVGQVVMVChcbiAgICAgICAgICBleHRyYWN0KFxuICAgICAgICAgICAgICBlcG9jaFxuICAgICAgICAgICAgICBmcm9tIG5vdygpXG4gICAgICAgICAgKSAqIDEwMDBcbiAgICAgICkgXG4gICk7XG5gO1xuXG5jb25zdCBnZXRMYXRlc3RWZXJzaW9uUXVlcnkgPSBgXG4gIFNFTEVDVCBpZCwgdmVyc2lvblxuICBGUk9NIG1pZ3JhdGlvblxuICBPUkRFUiBCWSBpZCBERVNDXG4gIExJTUlUIDE7XG5gO1xuXG5jb25zdCBpbnNlcnRWZXJzaW9uUXVlcnkgPSBgXG4gIElOU0VSVCBJTlRPIG1pZ3JhdGlvbihpZCwgdmVyc2lvbikgVkFMVUVTKCQxLCAkMik7XG5gO1xuXG5jb25zdCBkZWxldGVWZXJzaW9uUXVlcnkgPSBgXG4gIERFTEVURSBGUk9NIG1pZ3JhdGlvbiBXSEVSRSB2ZXJzaW9uID0gJDE7XG5gO1xuXG5jb25zdCBwZXJmb3JtTWlncmF0aW9uID0gKHtcbiAgY3VycmVudFZlcnNpb24sXG4gIG1vZGUsXG4gIHRhcmdldFZlcnNpb24sXG4gIGNsaWVudCxcbiAgbWlncmF0aW9uRm9sZGVyLFxufToge1xuICBjdXJyZW50VmVyc2lvbjoge1xuICAgIGlkOiBudW1iZXI7XG4gICAgdmVyc2lvbjogc3RyaW5nO1xuICB9O1xuICBtb2RlOiBzdHJpbmc7XG4gIHRhcmdldFZlcnNpb246IHN0cmluZztcbiAgY2xpZW50OiBQb29sQ2xpZW50O1xuICBtaWdyYXRpb25Gb2xkZXI6IHN0cmluZztcbn0pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgY29uc3QgdmVyc2lvbkZpbGVQYXRocyA9IGZzLnJlYWRkaXJTeW5jKGAke21pZ3JhdGlvbkZvbGRlcn0vJHttb2RlfWApO1xuICBpZiAodGFyZ2V0VmVyc2lvbiAmJiAhdmVyc2lvbkZpbGVQYXRocy5pbmNsdWRlcyhgJHt0YXJnZXRWZXJzaW9ufS5zcWxgKSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoYEludmFsaWQgdGFyZ2V0IHZlcnNpb246ICR7dGFyZ2V0VmVyc2lvbn1gKSk7XG4gIH1cbiAgbGV0IGN1cnJlbnRJZCA9IGN1cnJlbnRWZXJzaW9uID8gY3VycmVudFZlcnNpb24uaWQgOiAtMTtcbiAgY29uc3QgY3VycmVudFZlciA9IGN1cnJlbnRWZXJzaW9uPy52ZXJzaW9uO1xuICBjb25zdCBjdXJyZW50VmVyc2lvbkluZGV4ID0gdmVyc2lvbkZpbGVQYXRocy5pbmRleE9mKGAke2N1cnJlbnRWZXJ9LnNxbGApO1xuICBjb25zdCB0YXJnZXRWZXJzaW9uSW5kZXggPSB2ZXJzaW9uRmlsZVBhdGhzLmluZGV4T2YoYCR7dGFyZ2V0VmVyc2lvbn0uc3FsYCk7XG5cbiAgbGV0IGV4ZWN1dG9yID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIGlmIChtb2RlID09PSAndXAnKSB7XG4gICAgdmVyc2lvbkZpbGVQYXRoc1xuICAgICAgLmZpbHRlcihcbiAgICAgICAgKF92ZXJzaW9uRmlsZVBhdGgsIGluZGV4KSA9PiBpbmRleCA+IGN1cnJlbnRWZXJzaW9uSW5kZXggJiYgKCF0YXJnZXRWZXJzaW9uIHx8IGluZGV4IDw9IHRhcmdldFZlcnNpb25JbmRleCksXG4gICAgICApXG4gICAgICAuZm9yRWFjaCgodmVyc2lvbkZpbGVQYXRoKSA9PiB7XG4gICAgICAgIGV4ZWN1dG9yID0gZXhlY3V0b3JcbiAgICAgICAgICAudGhlbigoKSA9PiBjb25zb2xlLmxvZyhgTWlncmF0aW5nIHVwICR7dmVyc2lvbkZpbGVQYXRofS4uLmApKVxuICAgICAgICAgIC50aGVuKCgpID0+IGNsaWVudC5xdWVyeShmcy5yZWFkRmlsZVN5bmMoYCR7bWlncmF0aW9uRm9sZGVyfS8ke21vZGV9LyR7dmVyc2lvbkZpbGVQYXRofWAsICd1dGY4JykpKVxuICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGN1cnJlbnRJZCArPSAxO1xuICAgICAgICAgICAgcmV0dXJuIGNsaWVudC5xdWVyeShpbnNlcnRWZXJzaW9uUXVlcnksIFtjdXJyZW50SWQsIHZlcnNpb25GaWxlUGF0aC5zcGxpdCgnLicpWzBdXSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICByZXR1cm4gZXhlY3V0b3I7XG4gIH1cblxuICBpZiAoIXRhcmdldFZlcnNpb24pIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGBUYXJnZXQgdmVyc2lvbiBpcyByZXF1aXJlZCFgKSk7XG4gIH1cblxuICB2ZXJzaW9uRmlsZVBhdGhzXG4gICAgLmZpbHRlcigoX3ZlcnNpb25GaWxlUGF0aCwgaW5kZXgpID0+ICghdGFyZ2V0VmVyc2lvbiB8fCBpbmRleCA+IHRhcmdldFZlcnNpb25JbmRleCkgJiYgaW5kZXggPD0gY3VycmVudFZlcnNpb25JbmRleClcbiAgICAucmV2ZXJzZSgpXG4gICAgLmZvckVhY2goKHZlcnNpb25GaWxlUGF0aCkgPT4ge1xuICAgICAgZXhlY3V0b3IgPSBleGVjdXRvclxuICAgICAgICAudGhlbigoKSA9PiBjb25zb2xlLmxvZyhgTWlncmF0aW5nIGRvd24gJHt2ZXJzaW9uRmlsZVBhdGh9Li4uYCkpXG4gICAgICAgIC50aGVuKCgpID0+IGNsaWVudC5xdWVyeShmcy5yZWFkRmlsZVN5bmMoYCR7bWlncmF0aW9uRm9sZGVyfS8ke21vZGV9LyR7dmVyc2lvbkZpbGVQYXRofWAsICd1dGY4JykpKVxuICAgICAgICAudGhlbigoKSA9PiBjbGllbnQucXVlcnkoZGVsZXRlVmVyc2lvblF1ZXJ5LCBbdmVyc2lvbkZpbGVQYXRoLnNwbGl0KCcuJylbMF1dKSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIHJldHVybiBleGVjdXRvcjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWlncmF0ZURhdGFiYXNlUGFyYW1zIHtcbiAgbW9kZTogJ3VwJyB8ICdkb3duJztcbiAgdGFyZ2V0VmVyc2lvbj86IHN0cmluZztcbiAgbWlncmF0aW9uRm9sZGVyOiBzdHJpbmc7XG4gIHBvb2xDb25maWc6IFBvb2xDb25maWc7XG59XG5cbmV4cG9ydCBjb25zdCBtaWdyYXRlID0gKHttb2RlLCB0YXJnZXRWZXJzaW9uLCBtaWdyYXRpb25Gb2xkZXIsIHBvb2xDb25maWd9OiBNaWdyYXRlRGF0YWJhc2VQYXJhbXMpOiBQcm9taXNlPHZvaWQ+ID0+XG4gIG5ldyBQb29sKHBvb2xDb25maWcpLmNvbm5lY3QoKS50aGVuKChjbGllbnQpID0+XG4gICAgUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuKCgpID0+IGNsaWVudC5xdWVyeSgnQkVHSU4nKSlcbiAgICAgIC50aGVuKCgpID0+IGNsaWVudC5xdWVyeShjcmVhdGVNaWdyYXRpb25UYWJsZVF1ZXJ5KSlcbiAgICAgIC50aGVuKCgpID0+IGNsaWVudC5xdWVyeShnZXRMYXRlc3RWZXJzaW9uUXVlcnkpKVxuICAgICAgLnRoZW4oKHJlc3VsdDogUXVlcnlSZXN1bHQ8e2lkOiBudW1iZXI7IHZlcnNpb246IHN0cmluZ30+KSA9PlxuICAgICAgICByZXN1bHQucm93cy5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiByZXN1bHQucm93c1swXSxcbiAgICAgIClcbiAgICAgIC50aGVuKChjdXJyZW50VmVyc2lvbikgPT5cbiAgICAgICAgcGVyZm9ybU1pZ3JhdGlvbih7XG4gICAgICAgICAgbW9kZSxcbiAgICAgICAgICB0YXJnZXRWZXJzaW9uLFxuICAgICAgICAgIGN1cnJlbnRWZXJzaW9uLFxuICAgICAgICAgIGNsaWVudCxcbiAgICAgICAgICBtaWdyYXRpb25Gb2xkZXIsXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLnRoZW4oKCkgPT4gY2xpZW50LnF1ZXJ5KCdDT01NSVQnKSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiBjbGllbnQucXVlcnkoJ1JPTExCQUNLJykudGhlbigoKSA9PiBQcm9taXNlLnJlamVjdChlcnIpKSlcbiAgICAgIC5maW5hbGx5KCgpID0+IGNsaWVudC5yZWxlYXNlKCkpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgIH0pLFxuICApO1xuIl19
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.migrate = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _pg = require("pg");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-console */
const createMigrationTableQuery = `
  CREATE TABLE IF NOT EXISTS migration(
      id INT PRIMARY KEY,
      version VARCHAR(4000) NOT NULL,
      createdAt BIGINT NOT NULL DEFAULT(
          extract(
              epoch
              from now()
          ) * 1000
      ) 
  );
`;
const getLatestVersionQuery = `
  SELECT id, version
  FROM migration
  ORDER BY id DESC
  LIMIT 1;
`;
const insertVersionQuery = `
  INSERT INTO migration(id, version) VALUES($1, $2);
`;
const deleteVersionQuery = `
  DELETE FROM migration WHERE version = $1;
`;

const performMigration = ({
  currentVersion,
  mode,
  targetVersion,
  client,
  migrationFolder
}) => {
  const versionFilePaths = _fs.default.readdirSync(`${migrationFolder}/${mode}`);

  if (targetVersion && !versionFilePaths.includes(`${targetVersion}.sql`)) {
    return Promise.reject(new Error(`Invalid target version: ${targetVersion}`));
  }

  let currentId = currentVersion ? currentVersion.id : -1;
  const currentVer = currentVersion === null || currentVersion === void 0 ? void 0 : currentVersion.version;
  const currentVersionIndex = versionFilePaths.indexOf(`${currentVer}.sql`);
  const targetVersionIndex = versionFilePaths.indexOf(`${targetVersion}.sql`);
  let executor = Promise.resolve();

  if (mode === 'up') {
    versionFilePaths.filter((_versionFilePath, index) => {
      console.log(_versionFilePath, index, currentVersionIndex, targetVersion);
      return index > currentVersionIndex && (!targetVersion || index <= targetVersionIndex);
    }).forEach(versionFilePath => {
      executor = executor.then(() => console.log(`Migrating up ${versionFilePath}...`)).then(() => client.query(_fs.default.readFileSync(`${migrationFolder}/${mode}/${versionFilePath}`, 'utf8'))).then(() => {
        currentId += 1;
        return client.query(insertVersionQuery, [currentId, versionFilePath.split('.')[0]]);
      }).then(() => {// do nothing
      });
    });
    return executor;
  }

  console.log(targetVersion);

  if (!targetVersion) {
    return Promise.reject(new Error(`Target version is required!`));
  }

  versionFilePaths.filter((_versionFilePath, index) => (!targetVersion || index > targetVersionIndex) && index <= currentVersionIndex).reverse().forEach(versionFilePath => {
    executor = executor.then(() => console.log(`Migrating down ${versionFilePath}...`)).then(() => client.query(_fs.default.readFileSync(`${migrationFolder}/${mode}/${versionFilePath}`, 'utf8'))).then(() => client.query(deleteVersionQuery, [versionFilePath.split('.')[0]])).then(() => {// do nothing
    });
  });
  return executor;
};

const migrate = ({
  mode,
  targetVersion,
  migrationFolder,
  poolConfig
}) => new _pg.Pool(poolConfig).connect().then(client => Promise.resolve().then(() => client.query('BEGIN')).then(() => client.query(createMigrationTableQuery)).then(() => client.query(getLatestVersionQuery)).then(result => result.rows.length === 0 ? undefined : result.rows[0]).then(currentVersion => performMigration({
  mode,
  targetVersion,
  currentVersion,
  client,
  migrationFolder
})).then(() => client.query('COMMIT')).catch(err => client.query('ROLLBACK').then(() => Promise.reject(err))).finally(() => client.release()).then(() => {// do nothing
}));

exports.migrate = migrate;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9taWdyYXRlLnRzIl0sIm5hbWVzIjpbImNyZWF0ZU1pZ3JhdGlvblRhYmxlUXVlcnkiLCJnZXRMYXRlc3RWZXJzaW9uUXVlcnkiLCJpbnNlcnRWZXJzaW9uUXVlcnkiLCJkZWxldGVWZXJzaW9uUXVlcnkiLCJwZXJmb3JtTWlncmF0aW9uIiwiY3VycmVudFZlcnNpb24iLCJtb2RlIiwidGFyZ2V0VmVyc2lvbiIsImNsaWVudCIsIm1pZ3JhdGlvbkZvbGRlciIsInZlcnNpb25GaWxlUGF0aHMiLCJmcyIsInJlYWRkaXJTeW5jIiwiaW5jbHVkZXMiLCJQcm9taXNlIiwicmVqZWN0IiwiRXJyb3IiLCJjdXJyZW50SWQiLCJpZCIsImN1cnJlbnRWZXIiLCJ2ZXJzaW9uIiwiY3VycmVudFZlcnNpb25JbmRleCIsImluZGV4T2YiLCJ0YXJnZXRWZXJzaW9uSW5kZXgiLCJleGVjdXRvciIsInJlc29sdmUiLCJmaWx0ZXIiLCJfdmVyc2lvbkZpbGVQYXRoIiwiaW5kZXgiLCJjb25zb2xlIiwibG9nIiwiZm9yRWFjaCIsInZlcnNpb25GaWxlUGF0aCIsInRoZW4iLCJxdWVyeSIsInJlYWRGaWxlU3luYyIsInNwbGl0IiwicmV2ZXJzZSIsIm1pZ3JhdGUiLCJwb29sQ29uZmlnIiwiUG9vbCIsImNvbm5lY3QiLCJyZXN1bHQiLCJyb3dzIiwibGVuZ3RoIiwidW5kZWZpbmVkIiwiY2F0Y2giLCJlcnIiLCJmaW5hbGx5IiwicmVsZWFzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOzs7O0FBRkE7QUFJQSxNQUFNQSx5QkFBeUIsR0FBSTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBWEE7QUFhQSxNQUFNQyxxQkFBcUIsR0FBSTtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBTEE7QUFPQSxNQUFNQyxrQkFBa0IsR0FBSTtBQUM1QjtBQUNBLENBRkE7QUFJQSxNQUFNQyxrQkFBa0IsR0FB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Q0MsSUFBUCxDQUFZLENBQVosQ0FMM0MsRUFPR1YsSUFQSCxDQU9TNUIsY0FBRCxJQUNKRCxnQkFBZ0IsQ0FBQztBQUNmRSxFQUFBQSxJQURlO0FBRWZDLEVBQUFBLGFBRmU7QUFHZkYsRUFBQUEsY0FIZTtBQUlmRyxFQUFBQSxNQUplO0FBS2ZDLEVBQUFBO0FBTGUsQ0FBRCxDQVJwQixFQWdCR3dCLElBaEJILENBZ0JRLE1BQU16QixNQUFNLENBQUMwQixLQUFQLENBQWEsUUFBYixDQWhCZCxFQWlCR1ksS0FqQkgsQ0FpQlVDLEdBQUQsSUFBU3ZDLE1BQU0sQ0FBQzBCLEtBQVAsQ0FBYSxVQUFiLEVBQXlCRCxJQUF6QixDQUE4QixNQUFNbkIsT0FBTyxDQUFDQyxNQUFSLENBQWVnQyxHQUFmLENBQXBDLENBakJsQixFQWtCR0MsT0FsQkgsQ0FrQlcsTUFBTXhDLE1BQU0sQ0FBQ3lDLE9BQVAsRUFsQmpCLEVBbUJHaEIsSUFuQkgsQ0FtQlEsTUFBTSxDQUNWO0FBQ0QsQ0FyQkgsQ0FERixDQURLIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7UG9vbCwgUG9vbENsaWVudCwgUG9vbENvbmZpZywgUXVlcnlSZXN1bHR9IGZyb20gJ3BnJztcblxuY29uc3QgY3JlYXRlTWlncmF0aW9uVGFibGVRdWVyeSA9IGBcbiAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgbWlncmF0aW9uKFxuICAgICAgaWQgSU5UIFBSSU1BUlkgS0VZLFxuICAgICAgdmVyc2lvbiBWQVJDSEFSKDQwMDApIE5PVCBOVUxMLFxuICAgICAgY3JlYXRlZEF0IEJJR0lOVCBOT1QgTlVMTCBERUZBVUxUKFxuICAgICAgICAgIGV4dHJhY3QoXG4gICAgICAgICAgICAgIGVwb2NoXG4gICAgICAgICAgICAgIGZyb20gbm93KClcbiAgICAgICAgICApICogMTAwMFxuICAgICAgKSBcbiAgKTtcbmA7XG5cbmNvbnN0IGdldExhdGVzdFZlcnNpb25RdWVyeSA9IGBcbiAgU0VMRUNUIGlkLCB2ZXJzaW9uXG4gIEZST00gbWlncmF0aW9uXG4gIE9SREVSIEJZIGlkIERFU0NcbiAgTElNSVQgMTtcbmA7XG5cbmNvbnN0IGluc2VydFZlcnNpb25RdWVyeSA9IGBcbiAgSU5TRVJUIElOVE8gbWlncmF0aW9uKGlkLCB2ZXJzaW9uKSBWQUxVRVMoJDEsICQyKTtcbmA7XG5cbmNvbnN0IGRlbGV0ZVZlcnNpb25RdWVyeSA9IGBcbiAgREVMRVRFIEZST00gbWlncmF0aW9uIFdIRVJFIHZlcnNpb24gPSAkMTtcbmA7XG5cbmNvbnN0IHBlcmZvcm1NaWdyYXRpb24gPSAoe1xuICBjdXJyZW50VmVyc2lvbixcbiAgbW9kZSxcbiAgdGFyZ2V0VmVyc2lvbixcbiAgY2xpZW50LFxuICBtaWdyYXRpb25Gb2xkZXIsXG59OiB7XG4gIGN1cnJlbnRWZXJzaW9uOiB7XG4gICAgaWQ6IG51bWJlcjtcbiAgICB2ZXJzaW9uOiBzdHJpbmc7XG4gIH07XG4gIG1vZGU6IHN0cmluZztcbiAgdGFyZ2V0VmVyc2lvbjogc3RyaW5nO1xuICBjbGllbnQ6IFBvb2xDbGllbnQ7XG4gIG1pZ3JhdGlvbkZvbGRlcjogc3RyaW5nO1xufSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICBjb25zdCB2ZXJzaW9uRmlsZVBhdGhzID0gZnMucmVhZGRpclN5bmMoYCR7bWlncmF0aW9uRm9sZGVyfS8ke21vZGV9YCk7XG4gIGlmICh0YXJnZXRWZXJzaW9uICYmICF2ZXJzaW9uRmlsZVBhdGhzLmluY2x1ZGVzKGAke3RhcmdldFZlcnNpb259LnNxbGApKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgSW52YWxpZCB0YXJnZXQgdmVyc2lvbjogJHt0YXJnZXRWZXJzaW9ufWApKTtcbiAgfVxuICBsZXQgY3VycmVudElkID0gY3VycmVudFZlcnNpb24gPyBjdXJyZW50VmVyc2lvbi5pZCA6IC0xO1xuICBjb25zdCBjdXJyZW50VmVyID0gY3VycmVudFZlcnNpb24/LnZlcnNpb247XG4gIGNvbnN0IGN1cnJlbnRWZXJzaW9uSW5kZXggPSB2ZXJzaW9uRmlsZVBhdGhzLmluZGV4T2YoYCR7Y3VycmVudFZlcn0uc3FsYCk7XG4gIGNvbnN0IHRhcmdldFZlcnNpb25JbmRleCA9IHZlcnNpb25GaWxlUGF0aHMuaW5kZXhPZihgJHt0YXJnZXRWZXJzaW9ufS5zcWxgKTtcblxuICBsZXQgZXhlY3V0b3IgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgaWYgKG1vZGUgPT09ICd1cCcpIHtcbiAgICB2ZXJzaW9uRmlsZVBhdGhzXG4gICAgICAuZmlsdGVyKChfdmVyc2lvbkZpbGVQYXRoLCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhfdmVyc2lvbkZpbGVQYXRoLCBpbmRleCwgY3VycmVudFZlcnNpb25JbmRleCwgdGFyZ2V0VmVyc2lvbik7XG4gICAgICAgIHJldHVybiBpbmRleCA+IGN1cnJlbnRWZXJzaW9uSW5kZXggJiYgKCF0YXJnZXRWZXJzaW9uIHx8IGluZGV4IDw9IHRhcmdldFZlcnNpb25JbmRleCk7XG4gICAgICB9KVxuICAgICAgLmZvckVhY2goKHZlcnNpb25GaWxlUGF0aCkgPT4ge1xuICAgICAgICBleGVjdXRvciA9IGV4ZWN1dG9yXG4gICAgICAgICAgLnRoZW4oKCkgPT4gY29uc29sZS5sb2coYE1pZ3JhdGluZyB1cCAke3ZlcnNpb25GaWxlUGF0aH0uLi5gKSlcbiAgICAgICAgICAudGhlbigoKSA9PiBjbGllbnQucXVlcnkoZnMucmVhZEZpbGVTeW5jKGAke21pZ3JhdGlvbkZvbGRlcn0vJHttb2RlfS8ke3ZlcnNpb25GaWxlUGF0aH1gLCAndXRmOCcpKSlcbiAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBjdXJyZW50SWQgKz0gMTtcbiAgICAgICAgICAgIHJldHVybiBjbGllbnQucXVlcnkoaW5zZXJ0VmVyc2lvblF1ZXJ5LCBbY3VycmVudElkLCB2ZXJzaW9uRmlsZVBhdGguc3BsaXQoJy4nKVswXV0pO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgcmV0dXJuIGV4ZWN1dG9yO1xuICB9XG5cbiAgY29uc29sZS5sb2codGFyZ2V0VmVyc2lvbik7XG4gIGlmICghdGFyZ2V0VmVyc2lvbikge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoYFRhcmdldCB2ZXJzaW9uIGlzIHJlcXVpcmVkIWApKTtcbiAgfVxuXG4gIHZlcnNpb25GaWxlUGF0aHNcbiAgICAuZmlsdGVyKChfdmVyc2lvbkZpbGVQYXRoLCBpbmRleCkgPT4gKCF0YXJnZXRWZXJzaW9uIHx8IGluZGV4ID4gdGFyZ2V0VmVyc2lvbkluZGV4KSAmJiBpbmRleCA8PSBjdXJyZW50VmVyc2lvbkluZGV4KVxuICAgIC5yZXZlcnNlKClcbiAgICAuZm9yRWFjaCgodmVyc2lvbkZpbGVQYXRoKSA9PiB7XG4gICAgICBleGVjdXRvciA9IGV4ZWN1dG9yXG4gICAgICAgIC50aGVuKCgpID0+IGNvbnNvbGUubG9nKGBNaWdyYXRpbmcgZG93biAke3ZlcnNpb25GaWxlUGF0aH0uLi5gKSlcbiAgICAgICAgLnRoZW4oKCkgPT4gY2xpZW50LnF1ZXJ5KGZzLnJlYWRGaWxlU3luYyhgJHttaWdyYXRpb25Gb2xkZXJ9LyR7bW9kZX0vJHt2ZXJzaW9uRmlsZVBhdGh9YCwgJ3V0ZjgnKSkpXG4gICAgICAgIC50aGVuKCgpID0+IGNsaWVudC5xdWVyeShkZWxldGVWZXJzaW9uUXVlcnksIFt2ZXJzaW9uRmlsZVBhdGguc3BsaXQoJy4nKVswXV0pKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgcmV0dXJuIGV4ZWN1dG9yO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBNaWdyYXRlRGF0YWJhc2VQYXJhbXMge1xuICBtb2RlOiAndXAnIHwgJ2Rvd24nO1xuICB0YXJnZXRWZXJzaW9uPzogc3RyaW5nO1xuICBtaWdyYXRpb25Gb2xkZXI6IHN0cmluZztcbiAgcG9vbENvbmZpZzogUG9vbENvbmZpZztcbn1cblxuZXhwb3J0IGNvbnN0IG1pZ3JhdGUgPSAoe21vZGUsIHRhcmdldFZlcnNpb24sIG1pZ3JhdGlvbkZvbGRlciwgcG9vbENvbmZpZ306IE1pZ3JhdGVEYXRhYmFzZVBhcmFtcyk6IFByb21pc2U8dm9pZD4gPT5cbiAgbmV3IFBvb2wocG9vbENvbmZpZykuY29ubmVjdCgpLnRoZW4oKGNsaWVudCkgPT5cbiAgICBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgLnRoZW4oKCkgPT4gY2xpZW50LnF1ZXJ5KCdCRUdJTicpKVxuICAgICAgLnRoZW4oKCkgPT4gY2xpZW50LnF1ZXJ5KGNyZWF0ZU1pZ3JhdGlvblRhYmxlUXVlcnkpKVxuICAgICAgLnRoZW4oKCkgPT4gY2xpZW50LnF1ZXJ5KGdldExhdGVzdFZlcnNpb25RdWVyeSkpXG4gICAgICAudGhlbigocmVzdWx0OiBRdWVyeVJlc3VsdDx7aWQ6IG51bWJlcjsgdmVyc2lvbjogc3RyaW5nfT4pID0+XG4gICAgICAgIHJlc3VsdC5yb3dzLmxlbmd0aCA9PT0gMCA/IHVuZGVmaW5lZCA6IHJlc3VsdC5yb3dzWzBdLFxuICAgICAgKVxuICAgICAgLnRoZW4oKGN1cnJlbnRWZXJzaW9uKSA9PlxuICAgICAgICBwZXJmb3JtTWlncmF0aW9uKHtcbiAgICAgICAgICBtb2RlLFxuICAgICAgICAgIHRhcmdldFZlcnNpb24sXG4gICAgICAgICAgY3VycmVudFZlcnNpb24sXG4gICAgICAgICAgY2xpZW50LFxuICAgICAgICAgIG1pZ3JhdGlvbkZvbGRlcixcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAudGhlbigoKSA9PiBjbGllbnQucXVlcnkoJ0NPTU1JVCcpKVxuICAgICAgLmNhdGNoKChlcnIpID0+IGNsaWVudC5xdWVyeSgnUk9MTEJBQ0snKS50aGVuKCgpID0+IFByb21pc2UucmVqZWN0KGVycikpKVxuICAgICAgLmZpbmFsbHkoKCkgPT4gY2xpZW50LnJlbGVhc2UoKSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgfSksXG4gICk7XG4iXX0=
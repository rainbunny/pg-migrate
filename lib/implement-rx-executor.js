"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.implementRxExecutor = void 0;

var _rxjs = require("rxjs");

var _executeQuery = require("./execute-query");

var _buildQuery = require("./build-query");

/* eslint-disable no-param-reassign */
const implementRxExecutor = (executor, log) => {
  /** Execute query */
  executor.executeQuery = query => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)(query);
    return (0, _rxjs.from)((0, _executeQuery.executeQuery)(executor, queryText, params, log).then(res => res.rows));
  };
  /** Count records in the query */


  executor.count = query => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)({ ...query,
      fields: [],
      pageIndex: undefined,
      rowsPerPage: undefined,
      sortBy: undefined,
      limit: undefined,
      offset: undefined
    });
    const countQueryText = `SELECT COUNT(*) FROM (${queryText}) AS T`;
    return (0, _rxjs.from)((0, _executeQuery.executeQuery)(executor, countQueryText, params, log).then(res => res.rows[0].count));
  };
  /** Get record by id */


  executor.getById = table => (id, fields, idField = 'id') => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)({
      table,
      whereClause: `${idField} = :id`,
      fields,
      params: {
        id
      }
    });
    return (0, _rxjs.from)((0, _executeQuery.executeQuery)(executor, queryText, params).then(res => res.rows.length > 0 ? res.rows[0] : undefined));
  };
  /** create new record */


  executor.create = table => record => {
    const paramNames = Object.keys(record);
    const params = paramNames.map(name => record[name]);
    const fieldsText = paramNames.join(',');
    const paramsText = Array.from(Array(paramNames.length), (_x, i) => `$${i + 1}`).join(',');
    const queryText = `INSERT INTO ${table}(${fieldsText}) VALUES(${paramsText}) RETURNING id`;
    return (0, _rxjs.from)((0, _executeQuery.executeQuery)(executor, queryText, params, log).then(res => res.rows[0].id));
  };
  /** update existing record */


  executor.update = table => (id, updatedData, idField = 'id') => {
    const paramNames = Object.keys(updatedData);
    const params = paramNames.map(name => updatedData[name]);
    const paramsText = paramNames.map((paramName, index) => `${paramName}=$${index + 2}`).join(',');
    const queryText = `UPDATE ${table} SET ${paramsText} WHERE ${idField} = $1`;
    return (0, _rxjs.from)((0, _executeQuery.executeQuery)(executor, queryText, [id, ...params], log).then(() => {// do nothing
    }));
  };
  /** delete existing record */


  executor.remove = table => (id, idField = 'id') => {
    const queryText = `DELETE FROM ${table} WHERE ${idField} = $1`;
    return (0, _rxjs.from)((0, _executeQuery.executeQuery)(executor, queryText, [id], log).then(() => {// do nothing
    }));
  };

  return executor;
};

exports.implementRxExecutor = implementRxExecutor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbXBsZW1lbnQtcngtZXhlY3V0b3IudHMiXSwibmFtZXMiOlsiaW1wbGVtZW50UnhFeGVjdXRvciIsImV4ZWN1dG9yIiwibG9nIiwiZXhlY3V0ZVF1ZXJ5IiwicXVlcnkiLCJxdWVyeVRleHQiLCJwYXJhbXMiLCJ0aGVuIiwicmVzIiwicm93cyIsImNvdW50IiwiZmllbGRzIiwicGFnZUluZGV4IiwidW5kZWZpbmVkIiwicm93c1BlclBhZ2UiLCJzb3J0QnkiLCJsaW1pdCIsIm9mZnNldCIsImNvdW50UXVlcnlUZXh0IiwiZ2V0QnlJZCIsInRhYmxlIiwiaWQiLCJpZEZpZWxkIiwid2hlcmVDbGF1c2UiLCJsZW5ndGgiLCJjcmVhdGUiLCJyZWNvcmQiLCJwYXJhbU5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsIm1hcCIsIm5hbWUiLCJmaWVsZHNUZXh0Iiwiam9pbiIsInBhcmFtc1RleHQiLCJBcnJheSIsImZyb20iLCJfeCIsImkiLCJ1cGRhdGUiLCJ1cGRhdGVkRGF0YSIsInBhcmFtTmFtZSIsImluZGV4IiwicmVtb3ZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBTEE7QUFPTyxNQUFNQSxtQkFBbUIsR0FBRyxDQUNqQ0MsUUFEaUMsRUFFakNDLEdBRmlDLEtBR3RCO0FBQ1g7QUFDQUQsRUFBQUEsUUFBUSxDQUFDRSxZQUFULEdBQTRCQyxLQUFKLElBQXdDO0FBQzlELFVBQU07QUFBQ0MsTUFBQUEsU0FBRDtBQUFZQyxNQUFBQTtBQUFaLFFBQXNCLDRCQUFXRixLQUFYLENBQTVCO0FBQ0EsV0FBTyxnQkFBSyxnQ0FBZ0JILFFBQWhCLEVBQTBCSSxTQUExQixFQUFxQ0MsTUFBckMsRUFBNkNKLEdBQTdDLEVBQWtESyxJQUFsRCxDQUF3REMsR0FBRCxJQUFTQSxHQUFHLENBQUNDLElBQXBFLENBQUwsQ0FBUDtBQUNELEdBSEQ7QUFLQTs7O0FBQ0FSLEVBQUFBLFFBQVEsQ0FBQ1MsS0FBVCxHQUFrQk4sS0FBRCxJQUF3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LFVBQVUsQ0FBQ0csR0FBWCxDQUFnQkMsSUFBRCxJQUFVUyxXQUFXLENBQUNULElBQUQsQ0FBcEMsQ0FBZjtBQUNBLFVBQU1HLFVBQVUsR0FBR1AsVUFBVSxDQUFDRyxHQUFYLENBQWUsQ0FBQ1csU0FBRCxFQUFZQyxLQUFaLEtBQXVCLEdBQUVELFNBQVUsS0FBSUMsS0FBSyxHQUFHLENBQUUsRUFBaEUsRUFBbUVULElBQW5FLENBQXdFLEdBQXhFLENBQW5CO0FBQ0EsVUFBTTVCLFNBQVMsR0FBSSxVQUFTZSxLQUFNLFFBQU9jLFVBQVcsVUFBU1osT0FBUSxPQUFyRTtBQUNBLFdBQU8sZ0JBQ0wsZ0NBQWFyQixRQUFiLEVBQXVCSSxTQUF2QixFQUFrQyxDQUFDZ0IsRUFBRCxFQUFLLEdBQUdmLE1BQVIsQ0FBbEMsRUFBbURKLEdBQW5ELEVBQXdESyxJQUF4RCxDQUE2RCxNQUFNLENBQ2pFO0FBQ0QsS0FGRCxDQURLLENBQVA7QUFLRCxHQVpIO0FBY0E7OztBQUNBTixFQUFBQSxRQUFRLENBQUMwQyxNQUFULEdBQ0d2QixLQUFELElBQ0EsQ0FBS0MsRUFBTCxFQUFhQyxPQUFPLEdBQUcsSUFBdkIsS0FBa0Q7QUFDaEQsVUFBTWpCLFNBQVMsR0FBSSxlQUFjZSxLQUFNLFVBQVNFLE9BQVEsT0FBeEQ7QUFDQSxXQUFPLGdCQUNMLGdDQUFhckIsUUFBYixFQUF1QkksU0FBdkIsRUFBa0MsQ0FBQ2dCLEVBQUQsQ0FBbEMsRUFBd0NuQixHQUF4QyxFQUE2Q0ssSUFBN0MsQ0FBa0QsTUFBTSxDQUN0RDtBQUNELEtBRkQsQ0FESyxDQUFQO0FBS0QsR0FUSDs7QUFXQSxTQUFPTixRQUFQO0FBQ0QsQ0E3RU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuaW1wb3J0IHtmcm9tfSBmcm9tICdyeGpzJztcbmltcG9ydCB0eXBlIHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB0eXBlIHtEYlF1ZXJ5LCBSeEV4ZWN1dG9yLCBMb2dnZXIsIFJ4RXh0ZW5kZWRQb29sLCBSeEV4dGVuZGVkUG9vbENsaWVudH0gZnJvbSAnQGxpYi9pbnRlcmZhY2VzJztcbmltcG9ydCB7ZXhlY3V0ZVF1ZXJ5fSBmcm9tICcuL2V4ZWN1dGUtcXVlcnknO1xuaW1wb3J0IHtidWlsZFF1ZXJ5fSBmcm9tICcuL2J1aWxkLXF1ZXJ5JztcblxuZXhwb3J0IGNvbnN0IGltcGxlbWVudFJ4RXhlY3V0b3IgPSA8U291cmNlIGV4dGVuZHMgUnhFeHRlbmRlZFBvb2wgfCBSeEV4dGVuZGVkUG9vbENsaWVudD4oXG4gIGV4ZWN1dG9yOiBTb3VyY2UgJiBSeEV4ZWN1dG9yLFxuICBsb2c/OiBMb2dnZXIsXG4pOiBTb3VyY2UgPT4ge1xuICAvKiogRXhlY3V0ZSBxdWVyeSAqL1xuICBleGVjdXRvci5leGVjdXRlUXVlcnkgPSA8VD4ocXVlcnk6IERiUXVlcnkpOiBPYnNlcnZhYmxlPFRbXT4gPT4ge1xuICAgIGNvbnN0IHtxdWVyeVRleHQsIHBhcmFtc30gPSBidWlsZFF1ZXJ5KHF1ZXJ5KTtcbiAgICByZXR1cm4gZnJvbShleGVjdXRlUXVlcnk8VD4oZXhlY3V0b3IsIHF1ZXJ5VGV4dCwgcGFyYW1zLCBsb2cpLnRoZW4oKHJlcykgPT4gcmVzLnJvd3MpKTtcbiAgfTtcblxuICAvKiogQ291bnQgcmVjb3JkcyBpbiB0aGUgcXVlcnkgKi9cbiAgZXhlY3V0b3IuY291bnQgPSAocXVlcnk6IERiUXVlcnkpOiBPYnNlcnZhYmxlPG51bWJlcj4gPT4ge1xuICAgIGNvbnN0IHtxdWVyeVRleHQsIHBhcmFtc30gPSBidWlsZFF1ZXJ5KHtcbiAgICAgIC4uLnF1ZXJ5LFxuICAgICAgZmllbGRzOiBbXSxcbiAgICAgIHBhZ2VJbmRleDogdW5kZWZpbmVkLFxuICAgICAgcm93c1BlclBhZ2U6IHVuZGVmaW5lZCxcbiAgICAgIHNvcnRCeTogdW5kZWZpbmVkLFxuICAgICAgbGltaXQ6IHVuZGVmaW5lZCxcbiAgICAgIG9mZnNldDogdW5kZWZpbmVkLFxuICAgIH0pO1xuICAgIGNvbnN0IGNvdW50UXVlcnlUZXh0ID0gYFNFTEVDVCBDT1VOVCgqKSBGUk9NICgke3F1ZXJ5VGV4dH0pIEFTIFRgO1xuICAgIHJldHVybiBmcm9tKGV4ZWN1dGVRdWVyeTx7Y291bnQ6IG51bWJlcn0+KGV4ZWN1dG9yLCBjb3VudFF1ZXJ5VGV4dCwgcGFyYW1zLCBsb2cpLnRoZW4oKHJlcykgPT4gcmVzLnJvd3NbMF0uY291bnQpKTtcbiAgfTtcblxuICAvKiogR2V0IHJlY29yZCBieSBpZCAqL1xuICBleGVjdXRvci5nZXRCeUlkID1cbiAgICAodGFibGU6IHN0cmluZykgPT5cbiAgICA8UmVjb3JkLCBJZD4oaWQ6IElkLCBmaWVsZHM/OiBzdHJpbmdbXSwgaWRGaWVsZCA9ICdpZCcpOiBPYnNlcnZhYmxlPFJlY29yZCB8IHVuZGVmaW5lZD4gPT4ge1xuICAgICAgY29uc3Qge3F1ZXJ5VGV4dCwgcGFyYW1zfSA9IGJ1aWxkUXVlcnkoe3RhYmxlLCB3aGVyZUNsYXVzZTogYCR7aWRGaWVsZH0gPSA6aWRgLCBmaWVsZHMsIHBhcmFtczoge2lkfX0pO1xuICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgIGV4ZWN1dGVRdWVyeTxSZWNvcmQ+KGV4ZWN1dG9yLCBxdWVyeVRleHQsIHBhcmFtcykudGhlbigocmVzKSA9PlxuICAgICAgICAgIHJlcy5yb3dzLmxlbmd0aCA+IDAgPyByZXMucm93c1swXSA6IHVuZGVmaW5lZCxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfTtcblxuICAvKiogY3JlYXRlIG5ldyByZWNvcmQgKi9cbiAgZXhlY3V0b3IuY3JlYXRlID1cbiAgICAodGFibGU6IHN0cmluZykgPT5cbiAgICA8UmVjb3JkLCBJZD4ocmVjb3JkOiBQYXJ0aWFsPFJlY29yZD4pOiBPYnNlcnZhYmxlPElkPiA9PiB7XG4gICAgICBjb25zdCBwYXJhbU5hbWVzID0gT2JqZWN0LmtleXMocmVjb3JkKSBhcyAoa2V5b2YgUmVjb3JkKVtdO1xuICAgICAgY29uc3QgcGFyYW1zID0gcGFyYW1OYW1lcy5tYXAoKG5hbWUpID0+IHJlY29yZFtuYW1lXSk7XG4gICAgICBjb25zdCBmaWVsZHNUZXh0ID0gcGFyYW1OYW1lcy5qb2luKCcsJyk7XG4gICAgICBjb25zdCBwYXJhbXNUZXh0ID0gQXJyYXkuZnJvbShBcnJheShwYXJhbU5hbWVzLmxlbmd0aCksIChfeCwgaSkgPT4gYCQke2kgKyAxfWApLmpvaW4oJywnKTtcbiAgICAgIGNvbnN0IHF1ZXJ5VGV4dCA9IGBJTlNFUlQgSU5UTyAke3RhYmxlfSgke2ZpZWxkc1RleHR9KSBWQUxVRVMoJHtwYXJhbXNUZXh0fSkgUkVUVVJOSU5HIGlkYDtcbiAgICAgIHJldHVybiBmcm9tKGV4ZWN1dGVRdWVyeTx7aWQ6IElkfT4oZXhlY3V0b3IsIHF1ZXJ5VGV4dCwgcGFyYW1zLCBsb2cpLnRoZW4oKHJlcykgPT4gcmVzLnJvd3NbMF0uaWQpKTtcbiAgICB9O1xuXG4gIC8qKiB1cGRhdGUgZXhpc3RpbmcgcmVjb3JkICovXG4gIGV4ZWN1dG9yLnVwZGF0ZSA9XG4gICAgKHRhYmxlOiBzdHJpbmcpID0+XG4gICAgPFJlY29yZCwgSWQ+KGlkOiBJZCwgdXBkYXRlZERhdGE6IFBhcnRpYWw8UmVjb3JkPiwgaWRGaWVsZCA9ICdpZCcpOiBPYnNlcnZhYmxlPHZvaWQ+ID0+IHtcbiAgICAgIGNvbnN0IHBhcmFtTmFtZXMgPSBPYmplY3Qua2V5cyh1cGRhdGVkRGF0YSkgYXMgKGtleW9mIFJlY29yZClbXTtcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHBhcmFtTmFtZXMubWFwKChuYW1lKSA9PiB1cGRhdGVkRGF0YVtuYW1lXSk7XG4gICAgICBjb25zdCBwYXJhbXNUZXh0ID0gcGFyYW1OYW1lcy5tYXAoKHBhcmFtTmFtZSwgaW5kZXgpID0+IGAke3BhcmFtTmFtZX09JCR7aW5kZXggKyAyfWApLmpvaW4oJywnKTtcbiAgICAgIGNvbnN0IHF1ZXJ5VGV4dCA9IGBVUERBVEUgJHt0YWJsZX0gU0VUICR7cGFyYW1zVGV4dH0gV0hFUkUgJHtpZEZpZWxkfSA9ICQxYDtcbiAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICBleGVjdXRlUXVlcnkoZXhlY3V0b3IsIHF1ZXJ5VGV4dCwgW2lkLCAuLi5wYXJhbXNdLCBsb2cpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH07XG5cbiAgLyoqIGRlbGV0ZSBleGlzdGluZyByZWNvcmQgKi9cbiAgZXhlY3V0b3IucmVtb3ZlID1cbiAgICAodGFibGU6IHN0cmluZykgPT5cbiAgICA8SWQ+KGlkOiBJZCwgaWRGaWVsZCA9ICdpZCcpOiBPYnNlcnZhYmxlPHZvaWQ+ID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5VGV4dCA9IGBERUxFVEUgRlJPTSAke3RhYmxlfSBXSEVSRSAke2lkRmllbGR9ID0gJDFgO1xuICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgIGV4ZWN1dGVRdWVyeShleGVjdXRvciwgcXVlcnlUZXh0LCBbaWRdLCBsb2cpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH07XG5cbiAgcmV0dXJuIGV4ZWN1dG9yO1xufTtcbiJdfQ==
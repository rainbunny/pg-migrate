"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.migrateDatabase = void 0;

var _pgExtensions = require("@rainbunny/pg-extensions");

var _fs = _interopRequireDefault(require("fs"));

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-console */
const createMigrationTableQuery = `
  CREATE TABLE IF NOT EXISTS migration(
      id INT PRIMARY KEY,
      version VARCHAR(4000) NOT NULL,
      createdAt BIGINT NOT NULL DEFAULT(
          extract(
              epoch
              from now()
          ) * 1000
      ) 
  );
`;
const getLatestVersionQuery = `
  SELECT id, version
  FROM migration
  ORDER BY id DESC
  LIMIT 1;
`;
const insertVersionQuery = `
  INSERT INTO migration(id, version) VALUES(:id, :version);
`;
const deleteVersionQuery = `
  DELETE FROM migration WHERE version = :version;
`;

const performMigration = ({
  currentVersion,
  mode,
  targetVersion,
  client,
  migrationFolder
}) => {
  const versionFilePaths = _fs.default.readdirSync(`${migrationFolder}/${mode}`);

  if (targetVersion && !versionFilePaths.includes(`${targetVersion}.sql`)) {
    throw new Error(`Invalid target version: ${targetVersion}`);
  }

  let currentId = currentVersion ? currentVersion.id : -1;
  const currentVer = currentVersion === null || currentVersion === void 0 ? void 0 : currentVersion.version;
  const currentVersionIndex = versionFilePaths.indexOf(`${currentVer}.sql`);
  const targetVersionIndex = versionFilePaths.indexOf(`${targetVersion}.sql`);
  let executor = (0, _rxjs.of)(undefined);

  if (mode === 'up') {
    versionFilePaths.filter((_versionFilePath, index) => index > currentVersionIndex && (!targetVersion || index <= targetVersionIndex)).forEach(versionFilePath => {
      executor = executor.pipe((0, _operators.tap)(() => console.log(`Migrating up ${versionFilePath}...`)), (0, _operators.switchMap)(() => client.executeQuery({
        queryText: _fs.default.readFileSync(`${migrationFolder}/${mode}/${versionFilePath}`, 'utf8')
      })), (0, _operators.switchMap)(() => {
        currentId += 1;
        return client.executeQuery({
          queryText: insertVersionQuery,
          params: {
            id: currentId,
            version: versionFilePath.split('.')[0]
          }
        }).pipe((0, _operators.map)(() => {// do nothing
        }));
      }));
    });
    return executor;
  }

  if (!targetVersion) {
    throw new Error(`Target version is required!`);
  }

  versionFilePaths.filter((_versionFilePath, index) => (!targetVersion || index > targetVersionIndex) && index <= currentVersionIndex).reverse().forEach(versionFilePath => {
    executor = executor.pipe((0, _operators.tap)(() => console.log(`Migrating down ${versionFilePath}...`)), (0, _operators.switchMap)(() => client.executeQuery({
      queryText: _fs.default.readFileSync(`${migrationFolder}/${mode}/${versionFilePath}`, 'utf8')
    })), (0, _operators.switchMap)(() => client.executeQuery({
      queryText: deleteVersionQuery,
      params: {
        version: versionFilePath.split('.')[0]
      }
    }).pipe((0, _operators.map)(() => {// do nothing
    }))));
  });
  return executor;
};

const migrateDatabase = params => {
  const {
    mode,
    targetVersion,
    migrationFolder,
    poolConfig
  } = params;
  new _pgExtensions.RxPool(poolConfig).executeTransaction(client => (0, _rxjs.of)({}).pipe((0, _operators.switchMap)(() => client.executeQuery({
    queryText: createMigrationTableQuery
  })), (0, _operators.switchMap)(() => client.executeQuery({
    queryText: getLatestVersionQuery
  })), (0, _operators.map)(latestVersion => latestVersion.length === 0 ? undefined : latestVersion[0]), (0, _operators.switchMap)(currentVersion => performMigration({
    mode,
    targetVersion,
    currentVersion,
    client,
    migrationFolder
  })))).subscribe({
    complete: () => {
      console.log('Migration completed.');
    },
    error: e => console.error(e)
  });
};

exports.migrateDatabase = migrateDatabase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9taWdyYXRlLWRhdGFiYXNlLnRzIl0sIm5hbWVzIjpbImNyZWF0ZU1pZ3JhdGlvblRhYmxlUXVlcnkiLCJnZXRMYXRlc3RWZXJzaW9uUXVlcnkiLCJpbnNlcnRWZXJzaW9uUXVlcnkiLCJkZWxldGVWZXJzaW9uUXVlcnkiLCJwZXJmb3JtTWlncmF0aW9uIiwiY3VycmVudFZlcnNpb24iLCJtb2RlIiwidGFyZ2V0VmVyc2lvbiIsImNsaWVudCIsIm1pZ3JhdGlvbkZvbGRlciIsInZlcnNpb25GaWxlUGF0aHMiLCJmcyIsInJlYWRkaXJTeW5jIiwiaW5jbHVkZXMiLCJFcnJvciIsImN1cnJlbnRJZCIsImlkIiwiY3VycmVudFZlciIsInZlcnNpb24iLCJjdXJyZW50VmVyc2lvbkluZGV4IiwiaW5kZXhPZiIsInRhcmdldFZlcnNpb25JbmRleCIsImV4ZWN1dG9yIiwidW5kZWZpbmVkIiwiZmlsdGVyIiwiX3ZlcnNpb25GaWxlUGF0aCIsImluZGV4IiwiZm9yRWFjaCIsInZlcnNpb25GaWxlUGF0aCIsInBpcGUiLCJjb25zb2xlIiwibG9nIiwiZXhlY3V0ZVF1ZXJ5IiwicXVlcnlUZXh0IiwicmVhZEZpbGVTeW5jIiwicGFyYW1zIiwic3BsaXQiLCJyZXZlcnNlIiwibWlncmF0ZURhdGFiYXNlIiwicG9vbENvbmZpZyIsIlJ4UG9vbCIsImV4ZWN1dGVUcmFuc2FjdGlvbiIsImxhdGVzdFZlcnNpb24iLCJsZW5ndGgiLCJzdWJzY3JpYmUiLCJjb21wbGV0ZSIsImVycm9yIiwiZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBTEE7QUFPQSxNQUFNQSx5QkFBeUIsR0FBSTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBWEE7QUFhQSxNQUFNQyxxQkFBcUIsR0FBSTtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBTEE7QUFPQSxNQUFNQyxrQkFBa0Is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Q0FGRixFQUdFLG9CQUFLeUMsYUFBRCxJQUNGQSxhQUFhLENBQUNDLE1BQWQsS0FBeUIsQ0FBekIsR0FBNkJwQixTQUE3QixHQUF5Q21CLGFBQWEsQ0FBQyxDQUFELENBRHhELENBSEYsRUFNRSwwQkFBV3JDLGNBQUQsSUFDUkQsZ0JBQWdCLENBQUM7QUFDZkUsSUFBQUEsSUFEZTtBQUVmQyxJQUFBQSxhQUZlO0FBR2ZGLElBQUFBLGNBSGU7QUFJZkcsSUFBQUEsTUFKZTtBQUtmQyxJQUFBQTtBQUxlLEdBQUQsQ0FEbEIsQ0FORixDQUZKLEVBbUJHbUMsU0FuQkgsQ0FtQmE7QUFDVEMsSUFBQUEsUUFBUSxFQUFFLE1BQU07QUFDZGYsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksc0JBQVo7QUFDRCxLQUhRO0FBSVRlLElBQUFBLEtBQUssRUFBR0MsQ0FBRCxJQUFPakIsT0FBTyxDQUFDZ0IsS0FBUixDQUFjQyxDQUFkO0FBSkwsR0FuQmI7QUF5QkQsQ0E1Qk0iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG5cbmltcG9ydCB7RXh0ZW5kZWRQb29sQ29uZmlnLCBSeEV4dGVuZGVkUG9vbENsaWVudCwgUnhQb29sfSBmcm9tICdAcmFpbmJ1bm55L3BnLWV4dGVuc2lvbnMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXAsIHN3aXRjaE1hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmNvbnN0IGNyZWF0ZU1pZ3JhdGlvblRhYmxlUXVlcnkgPSBgXG4gIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIG1pZ3JhdGlvbihcbiAgICAgIGlkIElOVCBQUklNQVJZIEtFWSxcbiAgICAgIHZlcnNpb24gVkFSQ0hBUig0MDAwKSBOT1QgTlVMTCxcbiAgICAgIGNyZWF0ZWRBdCBCSUdJTlQgTk9UIE5VTEwgREVGQVVMVChcbiAgICAgICAgICBleHRyYWN0KFxuICAgICAgICAgICAgICBlcG9jaFxuICAgICAgICAgICAgICBmcm9tIG5vdygpXG4gICAgICAgICAgKSAqIDEwMDBcbiAgICAgICkgXG4gICk7XG5gO1xuXG5jb25zdCBnZXRMYXRlc3RWZXJzaW9uUXVlcnkgPSBgXG4gIFNFTEVDVCBpZCwgdmVyc2lvblxuICBGUk9NIG1pZ3JhdGlvblxuICBPUkRFUiBCWSBpZCBERVNDXG4gIExJTUlUIDE7XG5gO1xuXG5jb25zdCBpbnNlcnRWZXJzaW9uUXVlcnkgPSBgXG4gIElOU0VSVCBJTlRPIG1pZ3JhdGlvbihpZCwgdmVyc2lvbikgVkFMVUVTKDppZCwgOnZlcnNpb24pO1xuYDtcblxuY29uc3QgZGVsZXRlVmVyc2lvblF1ZXJ5ID0gYFxuICBERUxFVEUgRlJPTSBtaWdyYXRpb24gV0hFUkUgdmVyc2lvbiA9IDp2ZXJzaW9uO1xuYDtcblxuY29uc3QgcGVyZm9ybU1pZ3JhdGlvbiA9ICh7XG4gIGN1cnJlbnRWZXJzaW9uLFxuICBtb2RlLFxuICB0YXJnZXRWZXJzaW9uLFxuICBjbGllbnQsXG4gIG1pZ3JhdGlvbkZvbGRlcixcbn06IHtcbiAgY3VycmVudFZlcnNpb246IHtcbiAgICBpZDogbnVtYmVyO1xuICAgIHZlcnNpb246IHN0cmluZztcbiAgfTtcbiAgbW9kZTogc3RyaW5nO1xuICB0YXJnZXRWZXJzaW9uOiBzdHJpbmc7XG4gIGNsaWVudDogUnhFeHRlbmRlZFBvb2xDbGllbnQ7XG4gIG1pZ3JhdGlvbkZvbGRlcjogc3RyaW5nO1xufSk6IE9ic2VydmFibGU8dm9pZD4gPT4ge1xuICBjb25zdCB2ZXJzaW9uRmlsZVBhdGhzID0gZnMucmVhZGRpclN5bmMoYCR7bWlncmF0aW9uRm9sZGVyfS8ke21vZGV9YCk7XG4gIGlmICh0YXJnZXRWZXJzaW9uICYmICF2ZXJzaW9uRmlsZVBhdGhzLmluY2x1ZGVzKGAke3RhcmdldFZlcnNpb259LnNxbGApKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHRhcmdldCB2ZXJzaW9uOiAke3RhcmdldFZlcnNpb259YCk7XG4gIH1cbiAgbGV0IGN1cnJlbnRJZCA9IGN1cnJlbnRWZXJzaW9uID8gY3VycmVudFZlcnNpb24uaWQgOiAtMTtcbiAgY29uc3QgY3VycmVudFZlciA9IGN1cnJlbnRWZXJzaW9uPy52ZXJzaW9uO1xuICBjb25zdCBjdXJyZW50VmVyc2lvbkluZGV4ID0gdmVyc2lvbkZpbGVQYXRocy5pbmRleE9mKGAke2N1cnJlbnRWZXJ9LnNxbGApO1xuICBjb25zdCB0YXJnZXRWZXJzaW9uSW5kZXggPSB2ZXJzaW9uRmlsZVBhdGhzLmluZGV4T2YoYCR7dGFyZ2V0VmVyc2lvbn0uc3FsYCk7XG5cbiAgbGV0IGV4ZWN1dG9yID0gb2YodW5kZWZpbmVkIGFzIHZvaWQpO1xuICBpZiAobW9kZSA9PT0gJ3VwJykge1xuICAgIHZlcnNpb25GaWxlUGF0aHNcbiAgICAgIC5maWx0ZXIoXG4gICAgICAgIChfdmVyc2lvbkZpbGVQYXRoLCBpbmRleCkgPT4gaW5kZXggPiBjdXJyZW50VmVyc2lvbkluZGV4ICYmICghdGFyZ2V0VmVyc2lvbiB8fCBpbmRleCA8PSB0YXJnZXRWZXJzaW9uSW5kZXgpLFxuICAgICAgKVxuICAgICAgLmZvckVhY2goKHZlcnNpb25GaWxlUGF0aCkgPT4ge1xuICAgICAgICBleGVjdXRvciA9IGV4ZWN1dG9yLnBpcGUoXG4gICAgICAgICAgdGFwKCgpID0+IGNvbnNvbGUubG9nKGBNaWdyYXRpbmcgdXAgJHt2ZXJzaW9uRmlsZVBhdGh9Li4uYCkpLFxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICAgICAgY2xpZW50LmV4ZWN1dGVRdWVyeSh7cXVlcnlUZXh0OiBmcy5yZWFkRmlsZVN5bmMoYCR7bWlncmF0aW9uRm9sZGVyfS8ke21vZGV9LyR7dmVyc2lvbkZpbGVQYXRofWAsICd1dGY4Jyl9KSxcbiAgICAgICAgICApLFxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgICAgICBjdXJyZW50SWQgKz0gMTtcbiAgICAgICAgICAgIHJldHVybiBjbGllbnRcbiAgICAgICAgICAgICAgLmV4ZWN1dGVRdWVyeSh7XG4gICAgICAgICAgICAgICAgcXVlcnlUZXh0OiBpbnNlcnRWZXJzaW9uUXVlcnksXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7aWQ6IGN1cnJlbnRJZCwgdmVyc2lvbjogdmVyc2lvbkZpbGVQYXRoLnNwbGl0KCcuJylbMF19LFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgcmV0dXJuIGV4ZWN1dG9yO1xuICB9XG5cbiAgaWYgKCF0YXJnZXRWZXJzaW9uKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUYXJnZXQgdmVyc2lvbiBpcyByZXF1aXJlZCFgKTtcbiAgfVxuXG4gIHZlcnNpb25GaWxlUGF0aHNcbiAgICAuZmlsdGVyKChfdmVyc2lvbkZpbGVQYXRoLCBpbmRleCkgPT4gKCF0YXJnZXRWZXJzaW9uIHx8IGluZGV4ID4gdGFyZ2V0VmVyc2lvbkluZGV4KSAmJiBpbmRleCA8PSBjdXJyZW50VmVyc2lvbkluZGV4KVxuICAgIC5yZXZlcnNlKClcbiAgICAuZm9yRWFjaCgodmVyc2lvbkZpbGVQYXRoKSA9PiB7XG4gICAgICBleGVjdXRvciA9IGV4ZWN1dG9yLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiBjb25zb2xlLmxvZyhgTWlncmF0aW5nIGRvd24gJHt2ZXJzaW9uRmlsZVBhdGh9Li4uYCkpLFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgICBjbGllbnQuZXhlY3V0ZVF1ZXJ5KHtxdWVyeVRleHQ6IGZzLnJlYWRGaWxlU3luYyhgJHttaWdyYXRpb25Gb2xkZXJ9LyR7bW9kZX0vJHt2ZXJzaW9uRmlsZVBhdGh9YCwgJ3V0ZjgnKX0pLFxuICAgICAgICApLFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgICBjbGllbnRcbiAgICAgICAgICAgIC5leGVjdXRlUXVlcnkoe1xuICAgICAgICAgICAgICBxdWVyeVRleHQ6IGRlbGV0ZVZlcnNpb25RdWVyeSxcbiAgICAgICAgICAgICAgcGFyYW1zOiB7dmVyc2lvbjogdmVyc2lvbkZpbGVQYXRoLnNwbGl0KCcuJylbMF19LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBtYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICApLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9KTtcbiAgcmV0dXJuIGV4ZWN1dG9yO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBNaWdyYXRlRGF0YWJhc2VQYXJhbXMge1xuICBtb2RlOiAndXAnIHwgJ2Rvd24nO1xuICB0YXJnZXRWZXJzaW9uPzogc3RyaW5nO1xuICBtaWdyYXRpb25Gb2xkZXI6IHN0cmluZztcbiAgcG9vbENvbmZpZzogRXh0ZW5kZWRQb29sQ29uZmlnO1xufVxuXG5leHBvcnQgY29uc3QgbWlncmF0ZURhdGFiYXNlID0gKHBhcmFtczogTWlncmF0ZURhdGFiYXNlUGFyYW1zKTogdm9pZCA9PiB7XG4gIGNvbnN0IHttb2RlLCB0YXJnZXRWZXJzaW9uLCBtaWdyYXRpb25Gb2xkZXIsIHBvb2xDb25maWd9ID0gcGFyYW1zO1xuXG4gIG5ldyBSeFBvb2wocG9vbENvbmZpZylcbiAgICAuZXhlY3V0ZVRyYW5zYWN0aW9uKChjbGllbnQpID0+XG4gICAgICBvZih7fSkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+IGNsaWVudC5leGVjdXRlUXVlcnkoe3F1ZXJ5VGV4dDogY3JlYXRlTWlncmF0aW9uVGFibGVRdWVyeX0pKSxcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+IGNsaWVudC5leGVjdXRlUXVlcnkoe3F1ZXJ5VGV4dDogZ2V0TGF0ZXN0VmVyc2lvblF1ZXJ5fSkpLFxuICAgICAgICBtYXAoKGxhdGVzdFZlcnNpb246IHtpZDogbnVtYmVyOyB2ZXJzaW9uOiBzdHJpbmd9W10pID0+XG4gICAgICAgICAgbGF0ZXN0VmVyc2lvbi5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiBsYXRlc3RWZXJzaW9uWzBdLFxuICAgICAgICApLFxuICAgICAgICBzd2l0Y2hNYXAoKGN1cnJlbnRWZXJzaW9uKSA9PlxuICAgICAgICAgIHBlcmZvcm1NaWdyYXRpb24oe1xuICAgICAgICAgICAgbW9kZSxcbiAgICAgICAgICAgIHRhcmdldFZlcnNpb24sXG4gICAgICAgICAgICBjdXJyZW50VmVyc2lvbixcbiAgICAgICAgICAgIGNsaWVudCxcbiAgICAgICAgICAgIG1pZ3JhdGlvbkZvbGRlcixcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSxcbiAgICAgICksXG4gICAgKVxuICAgIC5zdWJzY3JpYmUoe1xuICAgICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ01pZ3JhdGlvbiBjb21wbGV0ZWQuJyk7XG4gICAgICB9LFxuICAgICAgZXJyb3I6IChlKSA9PiBjb25zb2xlLmVycm9yKGUpLFxuICAgIH0pO1xufTtcbiJdfQ==
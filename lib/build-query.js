"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildQuery = void 0;

const buildMainQuery = ({
  table,
  whereClause,
  fields
}) => {
  const fieldsClause = fields ? fields.map(field => `${field} as "${field}"`).join(',') : '';
  const whereQuery = whereClause ? ` WHERE ${whereClause}` : '';
  return `SELECT ${fieldsClause || '*'} FROM ${table}${whereQuery}`;
};

const buildSortBy = ({
  sortBy
}) => sortBy && sortBy.length > 0 ? ` ORDER BY ${sortBy.map(m => m.replace('|', ' ')).join(', ')}` : '';

const buildQueryWithoutParams = queryBuilder => {
  const {
    query,
    paramsArr
  } = queryBuilder;
  const {
    pageIndex,
    rowsPerPage
  } = query;
  let {
    limit,
    offset
  } = query;
  let {
    currentParamInx
  } = queryBuilder;
  let finalQueryText;

  if (query.queryText) {
    finalQueryText = query.queryText;
  } else {
    finalQueryText = buildMainQuery(query) + buildSortBy(query);

    if (typeof pageIndex === 'number' && typeof rowsPerPage === 'number') {
      limit = rowsPerPage;
      offset = rowsPerPage * pageIndex;
    }

    if (typeof limit === 'number') {
      finalQueryText += ` LIMIT $${currentParamInx}`;
      paramsArr.push(limit);
      currentParamInx += 1;
    }

    if (typeof offset === 'number') {
      finalQueryText += ` OFFSET $${currentParamInx}`;
      paramsArr.push(offset);
      currentParamInx += 1;
    }
  }

  return {
    query,
    finalQueryText,
    currentParamInx,
    paramsArr
  };
};

const addParams = queryBuilder => {
  const {
    query,
    paramsArr
  } = queryBuilder;
  let {
    finalQueryText,
    currentParamInx
  } = queryBuilder;
  const {
    params
  } = query;

  if (params) {
    Object.keys(params).forEach(paramName => {
      const splitQueryArr = finalQueryText.split(`:${paramName}`);

      if (splitQueryArr.length > 1) {
        let newQuery = splitQueryArr[0];
        splitQueryArr.forEach((part, index) => {
          if (index > 0) {
            newQuery += `$${currentParamInx}${part}`;
            paramsArr.push(params[paramName]);
            currentParamInx += 1;
          }
        });
        finalQueryText = newQuery;
      }
    });
  }

  return {
    query,
    finalQueryText,
    currentParamInx,
    paramsArr
  };
};
/** build postgres sql query & params */


const buildQuery = query => {
  const {
    finalQueryText,
    paramsArr
  } = addParams(buildQueryWithoutParams({
    query,
    finalQueryText: '',
    currentParamInx: 1,
    paramsArr: []
  }));
  return {
    queryText: finalQueryText,
    params: paramsArr
  };
};

exports.buildQuery = buildQuery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9idWlsZC1xdWVyeS50cyJdLCJuYW1lcyI6WyJidWlsZE1haW5RdWVyeSIsInRhYmxlIiwid2hlcmVDbGF1c2UiLCJmaWVsZHMiLCJmaWVsZHNDbGF1c2UiLCJtYXAiLCJmaWVsZCIsImpvaW4iLCJ3aGVyZVF1ZXJ5IiwiYnVpbGRTb3J0QnkiLCJzb3J0QnkiLCJsZW5ndGgiLCJtIiwicmVwbGFjZSIsImJ1aWxkUXVlcnlXaXRob3V0UGFyYW1zIiwicXVlcnlCdWlsZGVyIiwicXVlcnkiLCJwYXJhbXNBcnIiLCJwYWdlSW5kZXgiLCJyb3dzUGVyUGFnZSIsImxpbWl0Iiwib2Zmc2V0IiwiY3VycmVudFBhcmFtSW54IiwiZmluYWxRdWVyeVRleHQiLCJxdWVyeVRleHQiLCJwdXNoIiwiYWRkUGFyYW1zIiwicGFyYW1zIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJwYXJhbU5hbWUiLCJzcGxpdFF1ZXJ5QXJyIiwic3BsaXQiLCJuZXdRdWVyeSIsInBhcnQiLCJpbmRleCIsImJ1aWxkUXVlcnkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFVQSxNQUFNQSxjQUFjLEdBQUcsQ0FBQztBQUFDQyxFQUFBQSxLQUFEO0FBQVFDLEVBQUFBLFdBQVI7QUFBcUJDLEVBQUFBO0FBQXJCLENBQUQsS0FBbUQ7QUFDeEUsUUFBTUMsWUFBWSxHQUFHRCxNQUFNLEdBQUdBLE1BQU0sQ0FBQ0UsR0FBUCxDQUFZQyxLQUFELElBQVksR0FBRUEsS0FBTSxRQUFPQSxLQUFNLEdBQTVDLEVBQWdEQyxJQUFoRCxDQUFxRCxHQUFyRCxDQUFILEdBQStELEVBQTFGO0FBQ0EsUUFBTUMsVUFBVSxHQUFHTixXQUFXLEdBQUksVUFBU0EsV0FBWSxFQUF6QixHQUE2QixFQUEzRDtBQUNBLFNBQVEsVUFBU0UsWUFBWSxJQUFJLEdBQUksU0FBUUgsS0FBTSxHQUFFTyxVQUFXLEVBQWhFO0FBQ0QsQ0FKRDs7QUFNQSxNQUFNQyxXQUFXLEdBQUcsQ0FBQztBQUFDQyxFQUFBQTtBQUFE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QUFELENBQXJCO0FBQ0FULFlBQUFBLGVBQWUsSUFBSSxDQUFuQjtBQUNEO0FBQ0YsU0FORDtBQU9BQyxRQUFBQSxjQUFjLEdBQUdXLFFBQWpCO0FBQ0Q7QUFDRixLQWJEO0FBY0Q7O0FBQ0QsU0FBTztBQUNMbEIsSUFBQUEsS0FESztBQUVMTyxJQUFBQSxjQUZLO0FBR0xELElBQUFBLGVBSEs7QUFJTEwsSUFBQUE7QUFKSyxHQUFQO0FBTUQsQ0ExQkQ7QUE0QkE7OztBQUNPLE1BQU1vQixVQUFVLEdBQUlyQixLQUFELElBQTZEO0FBQ3JGLFFBQU07QUFBQ08sSUFBQUEsY0FBRDtBQUFpQk4sSUFBQUE7QUFBakIsTUFBOEJTLFNBQVMsQ0FDM0NaLHVCQUF1QixDQUFDO0FBQUNFLElBQUFBLEtBQUQ7QUFBUU8sSUFBQUEsY0FBYyxFQUFFLEVBQXhCO0FBQTRCRCxJQUFBQSxlQUFlLEVBQUUsQ0FBN0M7QUFBZ0RMLElBQUFBLFNBQVMsRUFBRTtBQUEzRCxHQUFELENBRG9CLENBQTdDO0FBSUEsU0FBTztBQUNMTyxJQUFBQSxTQUFTLEVBQUVELGNBRE47QUFFTEksSUFBQUEsTUFBTSxFQUFFVjtBQUZILEdBQVA7QUFJRCxDQVRNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge0RiUXVlcnl9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5cbmludGVyZmFjZSBRdWVyeUJ1aWxkZXIge1xuICBxdWVyeTogRGJRdWVyeTtcbiAgZmluYWxRdWVyeVRleHQ6IHN0cmluZztcbiAgY3VycmVudFBhcmFtSW54OiBudW1iZXI7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHBhcmFtc0FycjogYW55W107XG59XG5cbmNvbnN0IGJ1aWxkTWFpblF1ZXJ5ID0gKHt0YWJsZSwgd2hlcmVDbGF1c2UsIGZpZWxkc306IERiUXVlcnkpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBmaWVsZHNDbGF1c2UgPSBmaWVsZHMgPyBmaWVsZHMubWFwKChmaWVsZCkgPT4gYCR7ZmllbGR9IGFzIFwiJHtmaWVsZH1cImApLmpvaW4oJywnKSA6ICcnO1xuICBjb25zdCB3aGVyZVF1ZXJ5ID0gd2hlcmVDbGF1c2UgPyBgIFdIRVJFICR7d2hlcmVDbGF1c2V9YCA6ICcnO1xuICByZXR1cm4gYFNFTEVDVCAke2ZpZWxkc0NsYXVzZSB8fCAnKid9IEZST00gJHt0YWJsZX0ke3doZXJlUXVlcnl9YDtcbn07XG5cbmNvbnN0IGJ1aWxkU29ydEJ5ID0gKHtzb3J0Qnl9OiBEYlF1ZXJ5KTogc3RyaW5nID0+XG4gIHNvcnRCeSAmJiBzb3J0QnkubGVuZ3RoID4gMCA/IGAgT1JERVIgQlkgJHtzb3J0QnkubWFwKChtKSA9PiBtLnJlcGxhY2UoJ3wnLCAnICcpKS5qb2luKCcsICcpfWAgOiAnJztcblxuY29uc3QgYnVpbGRRdWVyeVdpdGhvdXRQYXJhbXMgPSAocXVlcnlCdWlsZGVyOiBRdWVyeUJ1aWxkZXIpOiBRdWVyeUJ1aWxkZXIgPT4ge1xuICBjb25zdCB7cXVlcnksIHBhcmFtc0Fycn0gPSBxdWVyeUJ1aWxkZXI7XG4gIGNvbnN0IHtwYWdlSW5kZXgsIHJvd3NQZXJQYWdlfSA9IHF1ZXJ5O1xuICBsZXQge2xpbWl0LCBvZmZzZXR9ID0gcXVlcnk7XG4gIGxldCB7Y3VycmVudFBhcmFtSW54fSA9IHF1ZXJ5QnVpbGRlcjtcbiAgbGV0IGZpbmFsUXVlcnlUZXh0OiBzdHJpbmc7XG5cbiAgaWYgKHF1ZXJ5LnF1ZXJ5VGV4dCkge1xuICAgIGZpbmFsUXVlcnlUZXh0ID0gcXVlcnkucXVlcnlUZXh0O1xuICB9IGVsc2Uge1xuICAgIGZpbmFsUXVlcnlUZXh0ID0gYnVpbGRNYWluUXVlcnkocXVlcnkpICsgYnVpbGRTb3J0QnkocXVlcnkpO1xuICAgIGlmICh0eXBlb2YgcGFnZUluZGV4ID09PSAnbnVtYmVyJyAmJiB0eXBlb2Ygcm93c1BlclBhZ2UgPT09ICdudW1iZXInKSB7XG4gICAgICBsaW1pdCA9IHJvd3NQZXJQYWdlO1xuICAgICAgb2Zmc2V0ID0gcm93c1BlclBhZ2UgKiBwYWdlSW5kZXg7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbGltaXQgPT09ICdudW1iZXInKSB7XG4gICAgICBmaW5hbFF1ZXJ5VGV4dCArPSBgIExJTUlUICQke2N1cnJlbnRQYXJhbUlueH1gO1xuICAgICAgcGFyYW1zQXJyLnB1c2gobGltaXQpO1xuICAgICAgY3VycmVudFBhcmFtSW54ICs9IDE7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJykge1xuICAgICAgZmluYWxRdWVyeVRleHQgKz0gYCBPRkZTRVQgJCR7Y3VycmVudFBhcmFtSW54fWA7XG4gICAgICBwYXJhbXNBcnIucHVzaChvZmZzZXQpO1xuICAgICAgY3VycmVudFBhcmFtSW54ICs9IDE7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBxdWVyeSxcbiAgICBmaW5hbFF1ZXJ5VGV4dCxcbiAgICBjdXJyZW50UGFyYW1JbngsXG4gICAgcGFyYW1zQXJyLFxuICB9O1xufTtcblxuY29uc3QgYWRkUGFyYW1zID0gKHF1ZXJ5QnVpbGRlcjogUXVlcnlCdWlsZGVyKTogUXVlcnlCdWlsZGVyID0+IHtcbiAgY29uc3Qge3F1ZXJ5LCBwYXJhbXNBcnJ9ID0gcXVlcnlCdWlsZGVyO1xuICBsZXQge2ZpbmFsUXVlcnlUZXh0LCBjdXJyZW50UGFyYW1Jbnh9ID0gcXVlcnlCdWlsZGVyO1xuICBjb25zdCB7cGFyYW1zfSA9IHF1ZXJ5O1xuICBpZiAocGFyYW1zKSB7XG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKChwYXJhbU5hbWUpID0+IHtcbiAgICAgIGNvbnN0IHNwbGl0UXVlcnlBcnIgPSBmaW5hbFF1ZXJ5VGV4dC5zcGxpdChgOiR7cGFyYW1OYW1lfWApO1xuICAgICAgaWYgKHNwbGl0UXVlcnlBcnIubGVuZ3RoID4gMSkge1xuICAgICAgICBsZXQgbmV3UXVlcnkgPSBzcGxpdFF1ZXJ5QXJyWzBdO1xuICAgICAgICBzcGxpdFF1ZXJ5QXJyLmZvckVhY2goKHBhcnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgaWYgKGluZGV4ID4gMCkge1xuICAgICAgICAgICAgbmV3UXVlcnkgKz0gYCQke2N1cnJlbnRQYXJhbUlueH0ke3BhcnR9YDtcbiAgICAgICAgICAgIHBhcmFtc0Fyci5wdXNoKHBhcmFtc1twYXJhbU5hbWVdKTtcbiAgICAgICAgICAgIGN1cnJlbnRQYXJhbUlueCArPSAxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGZpbmFsUXVlcnlUZXh0ID0gbmV3UXVlcnk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBxdWVyeSxcbiAgICBmaW5hbFF1ZXJ5VGV4dCxcbiAgICBjdXJyZW50UGFyYW1JbngsXG4gICAgcGFyYW1zQXJyLFxuICB9O1xufTtcblxuLyoqIGJ1aWxkIHBvc3RncmVzIHNxbCBxdWVyeSAmIHBhcmFtcyAqL1xuZXhwb3J0IGNvbnN0IGJ1aWxkUXVlcnkgPSAocXVlcnk6IERiUXVlcnkpOiB7cXVlcnlUZXh0OiBzdHJpbmc7IHBhcmFtcz86IHVua25vd25bXX0gPT4ge1xuICBjb25zdCB7ZmluYWxRdWVyeVRleHQsIHBhcmFtc0Fycn0gPSBhZGRQYXJhbXMoXG4gICAgYnVpbGRRdWVyeVdpdGhvdXRQYXJhbXMoe3F1ZXJ5LCBmaW5hbFF1ZXJ5VGV4dDogJycsIGN1cnJlbnRQYXJhbUlueDogMSwgcGFyYW1zQXJyOiBbXX0pLFxuICApO1xuXG4gIHJldHVybiB7XG4gICAgcXVlcnlUZXh0OiBmaW5hbFF1ZXJ5VGV4dCxcbiAgICBwYXJhbXM6IHBhcmFtc0FycixcbiAgfTtcbn07XG4iXX0=